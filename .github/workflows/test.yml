name: CI/CD Test Pipeline for Whisper Voice Auth Service

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}
          command_timeout: 10m
          script: |
            echo "🚀 Starting deployment to Whisper Voice Auth Service..."
            
            # Navigate to project directory
            cd ${{ secrets.PROJECT_PATH || '/home/deploy/whisper' }}
            
            # Pull latest code
            echo "📥 Pulling latest code..."
            git pull origin main
            
            # Pull and restart with docker compose
            echo "🐳 Updating and restarting services..."
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d --remove-orphans --force-recreate
            
            # Wait for service to start
            echo "⏳ Waiting for service to start..."
            sleep 15
            
            # Health check
            echo "🏥 Performing health check..."
            if curl -f http://localhost:8000/health > /dev/null 2>&1; then
              echo "✅ Health check passed!"
            else
              echo "⚠️ Health check failed, but service might still be starting..."
              docker compose -f docker-compose.prod.yml logs --tail=10 whisper-api
            fi
            
            # Cleanup old Docker images
            echo "🧹 Cleaning up old images..."
            docker image prune -f || echo "⚠️ Image cleanup failed"
            
            echo "🎉 Deployment completed!"
            echo "🌐 Service available at: http://$(hostname -I | cut -d' ' -f1):8000"

  notify:
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    steps:
      - name: Notify deployment result
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "✅ Whisper Voice Auth Service deployed successfully!"
            echo "📊 Deployment Summary:"
            echo "  - Status: ${{ needs.deploy.result }}"
            echo "  - Commit: ${{ github.sha }}"
            echo "  - Branch: ${{ github.ref_name }}"
            echo "  - Time: $(date)"
          else
            echo "❌ Deployment failed!"
            echo "🔍 Check the deployment logs for details"
            exit 1
          fi
